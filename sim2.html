<!DOCTYPE html>
<html ng-app="nLinkSim">

<head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.5/angular.min.js"></script>
	<script>

		var nLinkSim = angular.module('nLinkSim', []);
		nLinkSim.controller('mainController', function ($scope, $http, $interval) {

			$scope.svg = document.querySelector('svg');

			$scope.lens = [60, 60, 50, 40, 30];
			// Create an SVGPoint for future math
			$scope.pt = $scope.svg.createSVGPoint();
			// Get point in global SVG space
			$scope.cursorPoint = function (evt) {
				$scope.pt.x = evt.clientX; $scope.pt.y = evt.clientY;
				return $scope.pt.matrixTransform($scope.svg.getScreenCTM().inverse());
			}

			$scope.angs = [];
			for(i=0; i<$scope.lens.length; i++) $scope.angs[i] = 0;

			$scope.forwardKinematics = function(){
				var screen = $scope.svg.getBoundingClientRect();
				$scope.pts = [{}];
				$scope.pts[0].x = screen.width / 2;
				$scope.pts[0].y = screen.height / 2;
				for(i=0; i<$scope.lens.length; i++){
					$scope.pts[i+1] = {
						x:($scope.pts[i].x + $scope.lens[i]*Math.cos($scope.angs[i])), 
						y:($scope.pts[i].y + $scope.lens[i]*Math.sin($scope.angs[i]))
					};
					
				}

			}//forwardKinematics
			
			$scope.inverseKinematics = function(){
				$scope.forwardKinematics();
				if($scope.G) {

				}
			}


			$scope.inverseKinematics();


			$scope.m = function (evt) {
				var t = $scope.cursorPoint(evt);
				$scope.G = t;
			}


/*
			$scope.showrobot = function (angs, lens) {
				var screen = $scope.svg.getBoundingClientRect();
				$scope.xc = screen.width / 2;
				$scope.yc = screen.height / 2;
				var pts = [];
				pts[0] = { x: $scope.xc, y: $scope.yc };
				//pts[0] = {x:0,y:0};
				var angsum = 0;

				for (i = 0; i < angs.length; i++) {
					angsum += angs[i];
					pts[i + 1] = {};
					pts[i + 1].x = pts[i].x + lens[i] * Math.cos(angsum);
					pts[i + 1].y = pts[i].y + lens[i] * Math.sin(angsum);
				}
				//console.log(pts);
				return pts;
			}

			$scope.nlinkjac = function (angs, lens) {
				var jac = [];

				var angsum = 0;
				for (i = 0; i < angs.length; i++) {
					angsum += angs[i];
				}

				jac[angs.length - 1] = {};

				jac[angs.length - 1].x = -lens[lens.length - 1] * Math.sin(angsum);
				jac[angs.length - 1].y = lens[lens.length - 1] * Math.cos(angsum);

				for (i = angs.length - 2; i >= 0; i--) {
					angsum -= angs[i];
					jac[i] = {};
					jac[i].x = jac[i + 1].x - lens[i] * Math.sin(angsum);
					jac[i].y = jac[i + 1].y + lens[i] * Math.cos(angsum);
				}

				return jac;
			}

			$scope.gotopoint = function (pt, lens) {
				var angs = [];

				for (i = 0; i < lens.length; i++) {
					angs[i] = 0;
				}

				var pts = $scope.showrobot(angs, lens);
				$scope.pts = pts;
				console.log($scope.pts);

				$scope.vec = { x: (pt.x - pts[pts.length - 1].x), y: (pt.y - pts[pts.length - 1].y) };

				$scope.dist = Math.hypot($scope.vec.x, $scope.vec.y);

				$scope.eps = .001;
				$scope.lambda = .01 / 60000; // /maxlens

				$scope.angs = angs;

				//while (dist > eps) {
					// console.log("while");

					// var jac = $scope.nlinkjac(angs, lens);
					// var dangs = [];
					// for(i=0; i<jac.length; i++){
					// 	dangs[i] = lambda*jac[i].x*vec.x + lambda*jac[i].y*vec.y;
					// 	angs[i] += dangs[i];
					// }
					// pts = $scope.showrobot(angs, lens);
					// $scope.pts = pts;
					// vec = { x: (pt.x - pts[pts.length - 1].x), y: (pt.y - pts[pts.length - 1].y) };
					// dist = Math.hypot(vec.x, vec.y);

				//}
			}

			$scope.mainloop = function (angs, lens) {
				if ($scope.dist > $scope.eps) {
					console.log("while");

					var jac = $scope.nlinkjac(angs, lens);
					var dangs = [];
					for (i = 0; i < jac.length; i++) {
						dangs[i] = $scope.lambda * jac[i].x * $scope.vec.x + $scope.lambda * jac[i].y * $scope.vec.y;
						angs[i] += dangs[i];
					}
					pts = $scope.showrobot(angs, lens);
					$scope.pts = pts;
					vec = { x: ($scope.G.x - pts[pts.length - 1].x), y: ($scope.G.y - pts[pts.length - 1].y) };
					dist = Math.hypot(vec.x, vec.y);
				}
			}

			$scope.m = function (evt) {
				//$scope.G = 
				var t = $scope.cursorPoint(evt);
				//if(Math.hypot(t.x-$scope.center.x,t.y-$scope.center.y) <$scope.totalLen){
				$scope.G = t;
				//}

				$scope.gotopoint($scope.G, $scope.lens);
				$interval(function(){
					$scope.mainloop($scope.angs, $scope.lens);
				}, 20)

			}
			*/

		}); //controller



	</script>

</head>

<body ng-controller="mainController">


	<svg id="mydrawing" ng-click="m($event)" style="background-color:white;position:absolute;top:0;left:0;width:100%;height:100%">
		<g ng-repeat="r in pts">
			<line ng-if="$index" style="stroke:{{$even?'red':'blue'}};stroke-width:2" ng-attr-x1="{{ pts[$index-1].x }}" ng-attr-y1="{{ pts[$index-1].y }}"
			 ng-attr-x2="{{r.x}}" ng-attr-y2="{{r.y}}"></line>
			<!-- <circle ng-attr-cx="{{r.x}}" ng-attr-cy="{{r.y}}" r="5" fill="blue"></circle> -->

		</g>
		<circle ng-attr-cx="{{G.x}}" ng-attr-cy="{{G.y}}" r="5" fill="red"></circle>

	</svg>

	<!--
		<div id="menu" style="position: absolute; display:none; border:1px solid black;">
		<button id="runRightTurn">Run Right-Turn</button> <br>
		<button id="runBug1">Run Bug1</button> <br>
		<button id="runBug2">Run Bug2</button> <br>
		<button id="stopButton">Stop</button> <br>
		<button onclick="location.reload()">Reset</button>
		</div>
	 -->
</body>

</html>

<!-- 
<svg id="mydrawing" ng-mousemove="trackMouse($event,AG)" ng-mousedown="mdown($event, AG);" ng-mouseup="mup();" width="600"
 height="600" style="border:1px solid black">

</svg>


<g ng-cloak="ng-cloak" ng-repeat="c in AGCol">
	<circle ng-attr-cx="{{AGColX[$index]}}" ng-attr-cy="{{(AG[c]==null)?-10:(AG[c]/5*10.667+105)}}" r="5" fill="{{(xc==$index)?'red':'blue'}}"></circle>
</g>
<g ng-cloak="ng-cloak" ng-repeat="c in AGBCol">
	<circle ng-attr-cx="{{AGColX[$index]}}" ng-attr-cy="{{(AG[c]==null)?-10:(AG[c]/5*10.667+105)}}" r="8" stroke="{{(xc==$index)?'red':'green'}}"
	 stroke-width="2" fill-opacity="0"></circle>
</g>
<br/> -->